#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Formatting..."
dart format --set-exit-if-changed .

echo "[pre-commit] Applying dart fix..."
dart fix --apply

# If fixes/format produced changes, stage them so they are part of this commit.
if ! git diff --quiet || ! git diff --cached --quiet; then
  git add -A
fi

echo "[pre-commit] Analyzing (non-blocking infos/warnings)..."
flutter analyze --no-fatal-infos --no-fatal-warnings || true

echo "[pre-commit] Running tests with coverage..."
# Adjust packages if using melos/workspaces.
flutter test --coverage

# Optional: simple coverage gate (lines). Replace with a robust tool if needed.
if command -v genhtml >/dev/null 2>&1; then
  genhtml coverage/lcov.info -o coverage/html >/dev/null 2>&1 || true
fi

echo "[pre-commit] Checking outdated dependencies..."
flutter pub outdated || true

echo "[pre-commit] Done."